# üîê CONFIGURAR GMAIL PARA ENVIAR EMAILS REALES - PASO A PASO

## ‚úÖ Lo que vas a lograr:

Despu√©s de seguir estos pasos:
- ‚úÖ Los usuarios recibir√°n el c√≥digo en su Gmail REAL
- ‚úÖ El c√≥digo funcionar√° para restablecer la contrase√±a
- ‚úÖ La nueva contrase√±a se guardar√° en la base de datos
- ‚úÖ El usuario podr√° hacer login con la nueva contrase√±a

---

## üìã PASO 1: Obtener Contrase√±a de Aplicaci√≥n de Google

### 1.1 Ve a tu cuenta de Google
üîó https://myaccount.google.com/

### 1.2 Habilita la Verificaci√≥n en 2 pasos
1. En el men√∫ izquierdo, haz clic en **"Seguridad"**
2. Busca **"Verificaci√≥n en 2 pasos"**
3. Si NO est√° activada, haz clic en **"Empezar"** y sigue los pasos
4. Verifica tu identidad con tu tel√©fono

### 1.3 Crea una Contrase√±a de Aplicaci√≥n
1. Vuelve a **"Seguridad"**
2. Busca **"Contrase√±as de aplicaciones"** (aparece despu√©s de activar verificaci√≥n en 2 pasos)
3. Haz clic en **"Contrase√±as de aplicaciones"**
4. Es posible que te pida tu contrase√±a de nuevo
5. En "Seleccionar app", elige **"Correo"**
6. En "Seleccionar dispositivo", elige **"Otro (nombre personalizado)"**
7. Escribe: **"EcoFact Django"**
8. Haz clic en **"Generar"**

### 1.4 Copia la contrase√±a
Google te mostrar√° una contrase√±a de 16 caracteres como:
```
abcd efgh ijkl mnop
```

**‚ö†Ô∏è IMPORTANTE:**
- Copia esta contrase√±a AHORA (no podr√°s verla despu√©s)
- Gu√°rdala en un lugar seguro
- Esta NO es tu contrase√±a normal de Gmail

---

## üîß PASO 2: Configurar Django

### 2.1 Abre el archivo de configuraci√≥n

Archivo: `EcoFactProject/settings.py`

### 2.2 Busca esta secci√≥n (al final del archivo):

```python
#CONFIGURACI√ìN MAILTRAP

EMAIL_BACKEND = "django.core.mail.backends.smtp.EmailBackend"
EMAIL_HOST = "sandbox.smtp.mailtrap.io"
EMAIL_HOST_USER = "37784d5fd7e4f7"
EMAIL_HOST_PASSWORD = "d1db56fe8a2834"
EMAIL_PORT = 587
EMAIL_USE_TLS = True
DEFAULT_FROM_EMAIL = "facturacion@ecofact.com"
```

### 2.3 Reempl√°zala con esto:

```python
# CONFIGURACI√ìN EMAIL REAL - GMAIL
# Los emails llegar√°n a las bandejas reales de los usuarios

EMAIL_BACKEND = "django.core.mail.backends.smtp.EmailBackend"
EMAIL_HOST = "smtp.gmail.com"
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = "TU_EMAIL@gmail.com"  # ‚Üê CAMBIA ESTO por tu Gmail
EMAIL_HOST_PASSWORD = "abcd efgh ijkl mnop"  # ‚Üê CAMBIA ESTO por tu contrase√±a de aplicaci√≥n
DEFAULT_FROM_EMAIL = "TU_EMAIL@gmail.com"  # ‚Üê CAMBIA ESTO por tu Gmail
```

### 2.4 Ejemplo real:

Si tu Gmail es `juandavid.dev@gmail.com` y tu contrase√±a de aplicaci√≥n es `abcd efgh ijkl mnop`:

```python
# CONFIGURACI√ìN EMAIL REAL - GMAIL

EMAIL_BACKEND = "django.core.mail.backends.smtp.EmailBackend"
EMAIL_HOST = "smtp.gmail.com"
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = "juandavid.dev@gmail.com"
EMAIL_HOST_PASSWORD = "abcd efgh ijkl mnop"
DEFAULT_FROM_EMAIL = "juandavid.dev@gmail.com"
```

### 2.5 Guarda el archivo

---

## üß™ PASO 3: Probar que funciona

### 3.1 Ejecuta el script de prueba:

```bash
python test_email.py
```

Esto enviar√° un email de prueba al primer usuario de tu BD.

### 3.2 Revisa el Gmail del usuario

Si el usuario en tu BD es `sebastiancortez@gmail.com`, revisa ESE Gmail.
El email deber√≠a llegar en menos de 1 minuto.

---

## ‚úÖ PASO 4: Probar el flujo completo

### 4.1 Inicia el servidor:

```bash
python manage.py runserver
```

### 4.2 Ve a la p√°gina de recuperaci√≥n:

üîó http://localhost:8000/olvido_contrase√±a/

### 4.3 Prueba con un usuario real:

Ejemplo de usuarios en tu BD:
- `juandavid@gmail.com` (vendedor)
- `sebastiancortez@gmail.com` (cliente)
- `superadmin@ecofact.com` (admin)
- `miguelrestrepo0330@gmail.com` (admin)

### 4.4 Sigue el proceso:

1. **Pantalla 1:** Ingresa el email del usuario
   - Ejemplo: `sebastiancortez@gmail.com`
   - Haz clic en "Enviar c√≥digo"

2. **Revisa el Gmail REAL del usuario:**
   - Ve a https://gmail.com
   - Inicia sesi√≥n como ese usuario
   - Busca un email de tu Gmail
   - Copia el c√≥digo de 6 d√≠gitos

3. **Pantalla 2:** Ingresa el c√≥digo
   - Pega el c√≥digo que recibiste
   - Haz clic en "Verificar c√≥digo"

4. **Pantalla 3:** Nueva contrase√±a
   - Ingresa una nueva contrase√±a (m√≠nimo 8 caracteres)
   - Confirma la contrase√±a
   - Haz clic en "Guardar nueva contrase√±a"

5. **Pantalla 4:** ¬°√âxito!
   - Ver√°s mensaje de √©xito
   - Haz clic en "Volver a inicio de sesi√≥n"

6. **Prueba el login:**
   - Ve a http://localhost:8000/login/
   - Ingresa el email del usuario
   - Ingresa la NUEVA contrase√±a que acabas de crear
   - ¬°Deber√≠as poder iniciar sesi√≥n! ‚úÖ

---

## üîç Verificar en la Base de Datos

### Opci√≥n 1: Django Admin

1. Ve a: http://localhost:8000/admin/
2. Login como superadmin
3. Ve a: **Core** ‚Üí **Usuarios**
4. Busca el usuario que cambi√≥ su contrase√±a
5. Ver√°s que la contrase√±a est√° hasheada (encriptada) ‚úÖ

### Opci√≥n 2: Django Shell

```bash
python manage.py shell
```

Luego:

```python
from core.models import Usuario

# Buscar el usuario
usuario = Usuario.objects.get(correo_electronico_usuario='sebastiancortez@gmail.com')

# Ver si la nueva contrase√±a funciona
usuario.check_password('NuevaPassword123')  # Deber√≠a retornar True
```

---

## üéØ RESUMEN DE LO QUE HACE EL SISTEMA

### Cuando un usuario pide recuperar contrase√±a:

```
1. Usuario ingresa su email
        ‚Üì
2. Sistema busca el usuario en la BD
        ‚Üì
3. Sistema genera:
   - Token JWT (v√°lido 1 hora)
   - C√≥digo de 6 d√≠gitos aleatorios
        ‚Üì
4. Sistema guarda en tabla PasswordResetToken:
   - Usuario
   - Token
   - C√≥digo
   - Fecha de expiraci√≥n
        ‚Üì
5. Sistema env√≠a email v√≠a TU GMAIL a:
   - Email del usuario (ej: sebastiancortez@gmail.com) ‚úÖ
        ‚Üì
6. Usuario recibe email en su Gmail REAL ‚úÖ
        ‚Üì
7. Usuario ingresa el c√≥digo de 6 d√≠gitos
        ‚Üì
8. Sistema verifica:
   - Token JWT v√°lido ‚úÖ
   - C√≥digo correcto ‚úÖ
   - No expirado ‚úÖ
   - No usado antes ‚úÖ
        ‚Üì
9. Usuario ingresa nueva contrase√±a
        ‚Üì
10. Sistema valida:
    - M√≠nimo 8 caracteres ‚úÖ
    - Al menos 1 may√∫scula ‚úÖ
    - Al menos 1 min√∫scula ‚úÖ
    - Al menos 1 n√∫mero ‚úÖ
    - Contrase√±as coinciden ‚úÖ
        ‚Üì
11. Sistema actualiza la contrase√±a en la BD:
    - usuario.set_password('nueva_password') ‚úÖ
    - usuario.save() ‚úÖ
        ‚Üì
12. Sistema marca el token como usado
        ‚Üì
13. ¬°Contrase√±a cambiada exitosamente! üéâ
```

---

## üîê Seguridad Implementada

‚úÖ **La contrase√±a se guarda encriptada en la BD**
   - Usa el sistema de hashing de Django
   - No se guarda en texto plano
   - Irreversible

‚úÖ **El token expira en 1 hora**
   - Despu√©s de 1 hora, el c√≥digo no sirve

‚úÖ **El c√≥digo solo se puede usar una vez**
   - Despu√©s de cambiar la contrase√±a, se marca como "usado"

‚úÖ **Validaci√≥n de fortaleza de contrase√±a**
   - M√≠nimo 8 caracteres
   - Debe tener may√∫sculas, min√∫sculas y n√∫meros

---

## ‚ùì Preguntas Frecuentes

### P: ¬øFunciona con cualquier email?
**R:** S√ç. El usuario puede tener Gmail, Outlook, Hotmail, Yahoo, etc.
Solo T√ö necesitas Gmail para ENVIAR los emails.

### P: ¬øPuedo usar mi Gmail personal?
**R:** S√ç. Puedes usar cualquier Gmail que tengas.

### P: ¬øLos emails van a spam?
**R:** A veces. Depende del proveedor de email del usuario.
Para evitarlo, puedes:
- Usar un dominio propio
- Usar SendGrid (m√°s profesional)

### P: ¬øCu√°ntos emails puedo enviar?
**R:** Con Gmail: hasta 500 emails por d√≠a (gratis)

### P: ¬øEs seguro poner mi contrase√±a en settings.py?
**R:** NO debes subirlo a GitHub.
Mejor usa variables de entorno (archivo .env)
Ver gu√≠a en: CONFIGURAR_EMAIL_REAL.md

### P: ¬øFunciona para admin, vendedor y cliente?
**R:** S√ç. Funciona para TODOS los roles. El sistema no distingue roles.

---

## üö® Soluci√≥n de Problemas

### Error: "No se pudo enviar el email"

**Causas posibles:**
1. Email o contrase√±a de aplicaci√≥n incorrectos
2. No activaste verificaci√≥n en 2 pasos
3. Gmail bloque√≥ el acceso

**Soluci√≥n:**
1. Verifica que copiaste bien el email y contrase√±a
2. Aseg√∫rate que sea contrase√±a de aplicaci√≥n (no tu contrase√±a normal)
3. Revisa que verificaci√≥n en 2 pasos est√© activada

### Error: "Token inv√°lido o expirado"

**Causa:** Han pasado m√°s de 1 hora

**Soluci√≥n:** Solicita un nuevo c√≥digo

### El email no llega

**Causas posibles:**
1. El email est√° en spam
2. Gmail del usuario no existe
3. Error de configuraci√≥n

**Soluci√≥n:**
1. Revisa la carpeta de spam del usuario
2. Verifica que el email existe en tu BD
3. Ejecuta: `python test_email.py` para verificar configuraci√≥n

---

## üìù CHECKLIST FINAL

Antes de usar en producci√≥n:

- [ ] Obtuve contrase√±a de aplicaci√≥n de Google
- [ ] Actualic√© settings.py con mi Gmail
- [ ] Ejecut√© test_email.py y funcion√≥
- [ ] Prob√© el flujo completo de recuperaci√≥n
- [ ] El email llega al Gmail real del usuario
- [ ] La contrase√±a se cambia en la BD
- [ ] Puedo hacer login con la nueva contrase√±a
- [ ] Configur√© variables de entorno (.env) para seguridad

---

## ‚úÖ ¬°LISTO!

Despu√©s de seguir estos pasos, tendr√°s:

‚úÖ Emails llegando a Gmails REALES
‚úÖ C√≥digo de 6 d√≠gitos funcionando
‚úÖ Contrase√±as cambi√°ndose en la BD
‚úÖ Sistema funcionando para admin, vendedor y cliente

---

**Tiempo estimado:** 10 minutos
**Dificultad:** F√°cil
**Costo:** Gratis

---

¬øNecesitas ayuda? Revisa los otros archivos:
- CONFIGURAR_EMAIL_REAL.md
- README_PASSWORD_RECOVERY.md
- ENTENDER_MAILTRAP.txt
